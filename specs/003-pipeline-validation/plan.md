# Implementation Plan: Photo Processing Pipeline Validation Tool

**Branch**: `003-pipeline-validation` | **Date**: 2025-12-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-pipeline-validation/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the execution workflow defined in `.specify/templates/commands/plan.md`.

## Summary

The Pipeline Validation Tool validates photo collections against user-defined processing workflows (pipelines) defined as directed graphs of nodes. The tool integrates with the existing Photo Pairing Tool to obtain file groupings, traverses pipeline paths from Capture to Termination nodes, and classifies each Specific Image as CONSISTENT, CONSISTENT-WITH-WARNING, PARTIAL, or INCONSISTENT. Results are presented in interactive HTML reports with Chart.js visualizations showing archival readiness statistics for multiple termination types (Black Box Archive, Browsable Archive).

**Core Value**: Automated validation of 10,000+ image groups in under 60 seconds (with caching), enabling photographers to identify incomplete processing workflows and assess archival readiness without manual file inspection.

## Technical Context

**Language/Version**: Python 3.10+ (required for match/case syntax and modern type hinting)
**Primary Dependencies**:
- PyYAML (>=6.0) - Pipeline configuration loading
- Jinja2 (>=3.1.0) - HTML template rendering
- pytest - Testing framework
- Existing: photo_pairing.py, PhotoStats metadata logic, PhotoAdminConfig, FilenameParser

**Storage**:
- Local filesystem (read-only for photos)
- JSON cache files (.photo_pairing_cache.json, .pipeline_validation_cache.json)
- YAML configuration (config/config.yaml with new processing_pipelines section)

**Testing**: pytest with target >70% overall coverage, >85% for validation engine core logic

**Target Platform**: Cross-platform CLI tool (macOS, Linux, Windows) - local filesystem analysis only

**Project Type**: Single standalone Python script (pipeline_validation.py) following photo-admin Independent CLI Tools architecture

**Performance Goals**:
- Analyze 10,000 image groups in <60 seconds (with cached Photo Pairing results)
- HTML report generation in <2 seconds for 5,000 groups
- Graph traversal with loop limit of 5 iterations to prevent infinite enumeration

**Constraints**:
- Read-only: NO file creation, modification, or deletion
- YAML-only pipeline configuration (no GUI editor in v1.0)
- 1:1 file evolution model (no multi-image merging like HDR/panorama)
- Maximum 100 nodes per pipeline, 50,000 ImageGroups per folder
- Batch mode only (no real-time monitoring)

**Scale/Scope**:
- 6 node types (Capture, File, Process, Pairing, Branching, Termination)
- 4 validation statuses (CONSISTENT, CONSISTENT-WITH-WARNING, PARTIAL, INCONSISTENT)
- Multiple concurrent termination paths per Specific Image
- Cache invalidation on 4 triggers (pipeline changes, folder changes, manual edits, version mismatch)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md`:

- [x] **Independent CLI Tools**:
  - ✅ Standalone Python script (pipeline_validation.py at repository root)
  - ✅ Uses PhotoAdminConfig from utils/config_manager.py
  - ✅ Can run independently (only depends on shared utilities, not other tools)
  - ✅ Integrates with Photo Pairing Tool by importing as module (same pattern as existing tools)

- [x] **Testing & Quality**:
  - ✅ Tests planned with pytest (target >70% overall, >85% validation engine)
  - ✅ Test organization: tests/test_pipeline_validation.py alongside existing test suite
  - ✅ pytest already configured in project

- [x] **User-Centric Design**:
  - ✅ HTML report generation with Jinja2 templates (FR-017, FR-018)
  - ✅ Clear, actionable error messages (pipeline validation errors with specific issues)
  - ✅ Simple implementation (YAGNI) - direct graph traversal, no complex frameworks
  - ✅ Structured logging for observability (progress indicators during long operations per FR-020)
  - ✅ --help/-h flags with comprehensive usage (FR-019)
  - ✅ Graceful CTRL+C handling (SIGINT with exit code 130 per constitution v1.1.0)

- [x] **Shared Infrastructure**:
  - ✅ Uses PhotoAdminConfig for YAML configuration loading
  - ✅ Extends shared config with new `processing_pipelines` section (A-001)
  - ✅ Respects photo_extensions and metadata_extensions from shared config
  - ✅ Timestamped HTML reports: pipeline_validation_report_YYYY-MM-DD_HH-MM-SS.html (A-006)
  - ✅ Uses centralized HTML templating (extends base.html.j2 per FR-017)
  - ✅ Cross-platform UTF-8 encoding (all file operations use encoding='utf-8' per constitution v1.1.1)

- [x] **Simplicity**:
  - ✅ Simplest approach: Direct directed graph traversal with sets for file deduplication
  - ✅ No premature abstractions: Node types as dataclasses, not complex class hierarchies
  - ✅ Reuses existing utilities (FilenameParser, PhotoAdminConfig, PhotoStats metadata logic)

**Violations/Exceptions**: None - all constitution principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/003-pipeline-validation/
├── spec.md              # Feature specification with 5 user stories, 22 FRs
├── plan.md              # This file (/speckit.plan output)
├── research.md          # Phase 0: Graph traversal patterns, caching strategies
├── data-model.md        # Phase 1: Pipeline nodes, validation results, cache metadata
├── quickstart.md        # Phase 1: Usage examples, configuration guide
├── contracts/           # Phase 1: Pipeline YAML schema, validation result JSON schema
│   ├── pipeline-config-schema.yaml
│   └── validation-result-schema.json
├── checklists/
│   └── requirements.md  # Specification quality validation (complete)
└── tasks.md             # Phase 2: NOT created by /speckit.plan, requires /speckit.tasks
```

### Source Code (repository root)

```text
pipeline_validation.py          # Main CLI script (standalone tool)

utils/                          # Shared utilities
├── config_manager.py          # PhotoAdminConfig (existing)
└── filename_parser.py         # FilenameParser (existing)

photo_pairing.py               # Dependency: ImageGroup generation (existing)
photo_stats.py                 # Dependency: XMP metadata logic (existing)

templates/                     # HTML report templates
├── base.html.j2              # Shared base template (existing)
└── pipeline_validation.html.j2  # Tool-specific template (new)

config/
├── template-config.yaml      # Extended with processing_pipelines section (update existing)
└── config.yaml               # User config (gitignored, generated from template)

tests/
└── test_pipeline_validation.py  # Comprehensive test suite (new)

docs/
└── pipeline-validation.md    # User documentation (new)
```

**Structure Decision**: Single project structure (Option 1) following photo-admin architecture. The tool is a standalone Python script at repository root, sharing infrastructure with existing PhotoStats and Photo Pairing tools. No web frontend or mobile components - pure CLI tool with HTML report output.

## Complexity Tracking

> **No violations to justify** - Constitution Check passed all requirements.

## Phase 0: Research & Architectural Decisions

### Research Topics

1. **Directed Graph Traversal Strategies**
   - **Decision needed**: Depth-first vs breadth-first for path enumeration
   - **Context**: Must enumerate all paths from Capture → Termination, handle loops (max 5 iterations), branching (ALL outputs), and parallel outputs

2. **Loop Detection & Prevention**
   - **Decision needed**: Loop detection algorithm (visited set per path vs global cycle detection)
   - **Context**: Process nodes can loop back (e.g., Photoshop iterative edits), need graceful truncation at 5 iterations

3. **File Node Deduplication Strategy**
   - **Decision needed**: Set-based deduplication data structure and timing
   - **Context**: Same file (e.g., AB3D0001.CR3) can appear multiple times in path as different nodes (raw_image_1, raw_image_2)

4. **Cache Invalidation Hash Strategy**
   - **Decision needed**: Hash algorithm (MD5, SHA256) and what to hash
   - **Context**: Four cache invalidation triggers: pipeline changes, folder changes, manual edits, version mismatch

5. **HTML Report Template Architecture**
   - **Decision needed**: Template inheritance structure and Chart.js integration pattern
   - **Context**: Must extend base.html.j2, include pie chart (status distribution) and bar chart (groups per path)

6. **Integration with Photo Pairing Tool**
   - **Decision needed**: Import as module vs subprocess vs cache file parsing
   - **Context**: Need ImageGroup structures, want to reuse cache, avoid re-scanning

7. **Validation Result Aggregation**
   - **Decision needed**: Single-pass vs multi-pass validation for multi-termination statistics
   - **Context**: Specific Image can match multiple terminations (count in both Black Box and Browsable)

8. **Pairing Node Path Enumeration** *(Added 2025-12-28)*
   - **Decision needed**: How to combine paths from 2 upstream branches at pairing nodes
   - **Context**: Pairing nodes must generate Cartesian product (branch1_paths × branch2_paths), handle topological ordering for nested pairing, merge path state (depth, files, iterations), prevent infinite loops
   - **Resolution**: Hybrid iterative approach with phase boundaries - DFS to pairing node → merge all combinations → continue DFS downstream. Longest-path algorithm for topological ordering. MAX_ITERATIONS=1 for pairing nodes (no loops allowed).

### Research Execution

I'll now dispatch research agents to resolve these unknowns and consolidate findings in research.md.

