# API Contract: Authenticated Binary Download

**Endpoint**: `GET /api/agent/v1/releases/{manifest_guid}/download/{platform}`
**Authentication**: Required (session cookie OR valid signed URL)

## Purpose

Serves an agent binary file from the server's distribution directory. Supports two authentication methods:
1. **Session cookie**: For in-browser downloads via the wizard's "Download Agent" button.
2. **Signed URL**: For remote/headless machine downloads via `curl` or `wget`. The signed URL is obtained from the active release endpoint.

## Request

```
GET /api/agent/v1/releases/{manifest_guid}/download/{platform}
GET /api/agent/v1/releases/{manifest_guid}/download/{platform}?expires={unix_ts}&signature={hmac_hex}
```

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `manifest_guid` | string | Release manifest GUID (e.g., `rel_01hgw2bbg...`) |
| `platform` | string | Platform identifier (e.g., `darwin-arm64`, `linux-amd64`) |

### Query Parameters (Signed URL mode only)

| Parameter | Type | Description |
|-----------|------|-------------|
| `expires` | integer | Unix timestamp (seconds) when the URL expires |
| `signature` | string | HMAC-SHA256 hex digest |

### Headers

| Header | Required | Description |
|--------|----------|-------------|
| `Cookie` | Conditional | Session cookie (when not using signed URL) |

No `Authorization` header is needed for signed URLs — the signature replaces bearer auth.

## Authentication Flow

```
1. If ?expires and ?signature are present:
   a. Verify expires > current time → 401 "Download link has expired"
   b. Compute expected = HMAC-SHA256(JWT_SECRET_KEY, "{manifest_guid}:{platform}:{expires}")
   c. Compare signature with expected (constant-time) → 401 "Invalid signature"
   d. Proceed to file serving

2. Else (no query params):
   a. Verify session cookie via get_tenant_context → 401 "Authentication required"
   b. Proceed to file serving
```

## Response

### 200 OK — Binary file stream

```
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="shuttersense-agent-darwin-arm64"
Content-Length: 52428800
```

The response body is the raw binary file streamed from disk.

### Response Headers

| Header | Description |
|--------|-------------|
| `Content-Type` | `application/octet-stream` |
| `Content-Disposition` | `attachment; filename="{artifact.filename}"` |
| `Content-Length` | File size in bytes |
| `X-Checksum-SHA256` | SHA-256 hex digest of the file (from artifact metadata) |

### 401 Unauthorized

**No session and no signed URL**:
```json
{
  "detail": "Authentication required"
}
```

**Signed URL expired**:
```json
{
  "detail": "Download link has expired. Please request a new link from the wizard."
}
```

**Invalid signature**:
```json
{
  "detail": "Invalid download link. Please request a new link from the wizard."
}
```

### 404 Not Found

**Manifest not found or inactive**:
```json
{
  "detail": "Release not found"
}
```

**Platform artifact not found**:
```json
{
  "detail": "No artifact found for platform 'darwin-arm64' in this release"
}
```

**Binary file missing from disk**:
```json
{
  "detail": "Agent binary file not found on server. Contact your administrator."
}
```

### 500 Internal Server Error

**Distribution directory not configured**:
```json
{
  "detail": "Agent binary distribution is not configured on this server"
}
```

## Signed URL Generation (Backend)

The signed URL is generated by the active release endpoint (not a separate endpoint) as part of the `ActiveReleaseResponse`.

```python
import hashlib
import hmac
import time

def generate_signed_download_url(
    manifest_guid: str,
    platform: str,
    secret_key: str,
    expires_in_seconds: int = 3600,  # 1 hour
) -> tuple[str, int]:
    """Generate a signed download URL.

    Returns (full_url, expires_timestamp).
    """
    expires = int(time.time()) + expires_in_seconds
    message = f"{manifest_guid}:{platform}:{expires}"
    signature = hmac.new(
        secret_key.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()

    url = (
        f"/api/agent/v1/releases/{manifest_guid}"
        f"/download/{platform}"
        f"?expires={expires}&signature={signature}"
    )
    return url, expires


def verify_signed_download_url(
    manifest_guid: str,
    platform: str,
    expires: int,
    signature: str,
    secret_key: str,
) -> bool:
    """Verify a signed download URL.

    Returns True if valid and not expired.
    """
    if int(time.time()) > expires:
        return False

    message = f"{manifest_guid}:{platform}:{expires}"
    expected = hmac.new(
        secret_key.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()

    return hmac.compare_digest(signature, expected)
```

## File Resolution

The binary file is located at:
```
{SHUSAI_AGENT_DIST_DIR}/{manifest.version}/{artifact.filename}
```

Example:
```
/opt/shuttersense/agent-dist/1.0.0/shuttersense-agent-darwin-arm64
```

### Security Constraints

1. **Path traversal prevention**: The filename from the artifact record is validated (no `/` or `\` characters). The version from the manifest is also validated. The full path is resolved and verified to be within `SHUSAI_AGENT_DIST_DIR`.
2. **No directory listing**: Only exact file matches are served.
3. **File existence**: The file must exist on disk. If not, return 404 with a message to contact the administrator.

## Frontend Usage

### In-Browser Download (Session Auth)

```typescript
// Browser handles cookies automatically
const downloadUrl = artifact.download_url  // relative URL from active release response
window.location.href = downloadUrl
// Or: create a hidden <a> element and click it
```

### Remote Machine Download (Signed URL)

The wizard displays the signed URL for the user to copy:
```bash
curl -o shuttersense-agent -L "https://your-server.com/api/agent/v1/releases/rel_.../download/linux-amd64?expires=1706832000&signature=abc123..."
```
