# Implementation Plan: Distributed Agent Architecture

**Branch**: `021-distributed-agent-architecture` | **Date**: 2026-01-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/021-distributed-agent-architecture/spec.md`
**PRD**: [docs/prd/021-distributed-agent-architecture.md](../../docs/prd/021-distributed-agent-architecture.md)

## Summary

Implement a distributed agent architecture that enables job execution on user-owned hardware. Agents are lightweight worker processes that poll for jobs, execute analysis tools locally, stream progress via WebSocket, and report results back to the server. This is a foundational architecture change: from this feature forward, **all jobs execute on agents** (server never executes jobs directly).

Key capabilities:
- Agent registration and lifecycle management
- Local collection binding to specific agents
- Capability-based job routing for remote connectors
- Three credential modes (SERVER, AGENT, PENDING)
- Real-time progress streaming via WebSocket
- Agent trust and result attestation
- Header-based agent pool status indicator

## Technical Context

**Language/Version**: Python 3.10+ (Backend/Agent), TypeScript 5.9.3 (Frontend)
**Primary Dependencies**:
- Backend: FastAPI, SQLAlchemy 2.0+, Pydantic v2, websockets, PyInstaller (agent packaging)
- Frontend: React 18.3.1, Tailwind CSS 4.x, shadcn/ui, Radix UI, Lucide React icons
**Storage**: PostgreSQL 12+ (job queue persistence, agent records)
**Testing**: pytest (backend/agent), Jest/Vitest (frontend)
**Target Platform**:
- Server: Linux (containerized)
- Agent: macOS 12+, Windows 10+, Ubuntu 20.04+
**Project Type**: web (frontend + backend + new agent binary)
**Performance Goals**:
- Job claim latency < 100ms (excluding network)
- 100+ concurrent agents per team
- 1000 jobs/minute throughput
- WebSocket progress latency < 200ms
**Constraints**:
- Agent binary < 50MB
- Agent runs without admin/root privileges
- Heartbeat every 30 seconds, offline after 90 seconds
**Scale/Scope**:
- 11 user stories (4 P0, 5 P1, 2 P2)
- 80+ functional requirements (FR-100 through FR-600)
- 5 new/enhanced database entities
- 15+ new API endpoints

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md`:

- [x] **Independent CLI Tools**: Agent bundles PhotoStats, Photo Pairing, Pipeline Validation as standalone executables. Tools can still run independently via CLI. Agent uses ConfigLoader interface abstraction.

- [x] **Testing & Quality**: Comprehensive test strategy planned - unit tests for services, integration tests for API endpoints, E2E tests for agent workflow, security tests for authentication. Target pytest for backend/agent.

- [x] **User-Centric Design**:
  - [x] HTML reports generated by agent and uploaded to server for storage
  - [x] Clear error messages for job failures, agent offline, etc.
  - [x] Simplest approach: PostgreSQL queue (not Redis), inline scheduling (no background tasks)
  - [x] Structured logging for agent operations and job lifecycle

- [x] **Global Unique Identifiers (GUIDs)**:
  - [x] Agent: `agt_` prefix
  - [x] AgentRegistrationToken: `art_` prefix
  - [x] All entities implement GuidMixin
  - [x] API responses use `.guid`, never expose `.id`

- [x] **Multi-Tenancy and Authentication**:
  - [x] Agents scoped to team (team_id FK)
  - [x] All agent endpoints require authentication (Bearer token)
  - [x] Cross-team job access returns 404
  - [x] TenantContext enforced on all queries

- [x] **Shared Infrastructure**: Tools use ConfigLoader interface abstraction
- [x] **Simplicity**: No Redis (PostgreSQL sufficient), no background scheduler (inline claim), single job per agent (v1)

**Violations/Exceptions**: None. All principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/021-distributed-agent-architecture/
├── plan.md              # This file
├── research.md          # PRD research consolidation (Phase 0)
├── data-model.md        # Entity definitions (Phase 1)
├── quickstart.md        # Developer quick start (Phase 1)
├── contracts/           # API contracts (Phase 1)
│   ├── agent-api.yaml   # Agent REST API (OpenAPI 3.1)
│   └── websocket-protocol.md  # WebSocket message formats
└── tasks.md             # Task breakdown (Phase 2 - /speckit.tasks)
```

### Source Code (repository root)

```text
# Backend additions
backend/
├── src/
│   ├── models/
│   │   ├── agent.py                 # Agent entity with GuidMixin
│   │   ├── agent_registration_token.py
│   │   └── job.py                   # Enhanced Job entity
│   ├── services/
│   │   ├── agent_service.py         # Agent lifecycle management
│   │   ├── job_coordinator_service.py  # Job routing and assignment
│   │   └── chunked_upload_service.py   # Result upload handling
│   ├── api/
│   │   ├── agent/
│   │   │   ├── __init__.py
│   │   │   ├── routes.py            # /api/agent/v1/* endpoints
│   │   │   └── schemas.py           # Pydantic models
│   │   └── config/
│   │       └── routes.py            # /api/config/* for agents
│   └── ws/
│       └── agent_progress.py        # WebSocket handler for agent progress
└── tests/
    ├── unit/
    │   ├── test_agent_service.py
    │   └── test_job_coordinator.py
    └── integration/
        └── test_agent_api.py

# Frontend additions
frontend/
├── src/
│   ├── components/
│   │   ├── agents/
│   │   │   ├── AgentList.tsx        # Agent list display
│   │   │   ├── AgentStatusBadge.tsx # Online/offline indicator
│   │   │   └── RegistrationTokenDialog.tsx
│   │   └── layout/
│   │       └── AgentPoolStatus.tsx  # Header status indicator
│   ├── pages/
│   │   └── AgentsPage.tsx           # Agent management page
│   ├── hooks/
│   │   ├── useAgents.ts             # Agent data fetching
│   │   └── useAgentPoolStatus.ts    # WebSocket subscription
│   └── contexts/
│       └── AgentPoolContext.tsx     # Real-time agent pool state
└── tests/
    └── components/
        └── agents/

# Agent binary (NEW top-level directory)
agent/
├── src/
│   ├── __init__.py
│   ├── main.py                      # Entry point
│   ├── config.py                    # Agent configuration
│   ├── api_client.py                # HTTP client for server
│   ├── polling_loop.py              # Main job polling loop
│   ├── job_executor.py              # Tool execution wrapper
│   ├── progress_reporter.py         # WebSocket/REST progress
│   ├── credential_store.py          # Local encrypted credentials
│   └── config_loader.py             # ApiConfigLoader implementation
├── cli/
│   ├── __init__.py
│   ├── main.py                      # CLI entry point
│   ├── register.py                  # Agent registration command
│   ├── connectors.py                # Connector credential management
│   └── capabilities.py              # Capability listing
├── packaging/
│   ├── build_macos.sh
│   ├── build_windows.sh
│   └── build_linux.sh
└── tests/
    ├── unit/
    │   ├── test_polling_loop.py
    │   └── test_job_executor.py
    └── integration/
        └── test_agent_registration.py
```

**Structure Decision**: Web application (frontend + backend) with new `agent/` top-level directory for the cross-platform agent binary. Agent is a separate Python package built with PyInstaller.

## Complexity Tracking

> No violations to justify. All constitution principles satisfied.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | - | - |

---

## Phase 1 Artifacts

The following artifacts are generated in Phase 1:

1. **research.md** - Consolidated PRD research decisions (complete)
2. **data-model.md** - Entity definitions, relationships, validation rules
3. **contracts/agent-api.yaml** - OpenAPI 3.1 specification for Agent API
4. **contracts/websocket-protocol.md** - WebSocket message formats
5. **quickstart.md** - Developer quick start guide

Phase 2 (`/speckit.tasks`) will generate the task breakdown.
