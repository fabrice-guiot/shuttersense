# ShutterSense Agent

Distributed agent for the ShutterSense photo processing pipeline. The agent runs on user-owned hardware and executes analysis jobs for photo collections, communicating with the ShutterSense server via secure REST API.

## Table of Contents

- [Architecture Overview](#architecture-overview)
- [Installation](#installation)
- [Quick Start](#quick-start)
- [CLI Commands](#cli-commands)
  - [register](#register)
  - [start](#start)
  - [config](#config)
  - [connectors](#connectors)
  - [capabilities](#capabilities)
  - [test](#test)
  - [collection](#collection)
  - [run](#run)
  - [sync](#sync)
  - [self-test](#self-test)
  - [debug (dev-only)](#debug-dev-only)
- [Source Structure](#source-structure)
- [Configuration](#configuration)
- [Environment Variables](#environment-variables)
- [Storage Adapters](#storage-adapters)
- [Analysis Tools](#analysis-tools)
- [Caching](#caching)
- [Testing](#testing)
- [Building](#building)
- [Dependencies](#dependencies)
- [License](#license)

## Architecture Overview

The ShutterSense agent follows a distributed architecture where the server acts as a coordinator and agents execute jobs locally:

1. **Server** creates jobs and assigns them to agents.
2. **Agents** poll the server for assigned jobs, execute analysis tools against photo collections, and report results back.
3. Collections can be bound to specific agents (required for local filesystem collections).
4. Agents support both online (upload results immediately) and offline (store locally, sync later) execution modes.

## Installation

### Development Mode

```bash
cd agent
pip install -e ".[dev]"
```

This installs the `shuttersense-agent` CLI command with all development dependencies.

### Build Standalone Binary

Standalone binaries are built with PyInstaller and produce a single executable file:

```bash
# macOS
./packaging/build_macos.sh

# Linux
./packaging/build_linux.sh

# Windows
./packaging/build_windows.sh

# All platforms
./packaging/build_all.sh
```

Release manifests can be created with:

```bash
./packaging/create_release.sh
```

## Quick Start

### 1. Register the Agent

Obtain a one-time registration token from the ShutterSense web UI (Settings > Agents), then:

```bash
shuttersense-agent register \
  --server https://your-server.example.com \
  --token art_xxxxx... \
  --name "My Workstation"
```

### 2. Configure Authorized Roots

Define which local directories the agent is allowed to access:

```bash
shuttersense-agent config set-roots /Users/photographer/Photos /Volumes/External
```

### 3. Start the Agent

```bash
shuttersense-agent start
```

The agent connects to the server and begins polling for jobs. It runs continuously until stopped with Ctrl+C or SIGTERM.

### 4. Create a Collection (Optional Manual Workflow)

```bash
# Test a local path
shuttersense-agent test /photos/2024

# Create a collection from it
shuttersense-agent collection create /photos/2024 --name "Vacation 2024"

# Run analysis
shuttersense-agent run col_01hgw... --tool photostats
```

## CLI Commands

### register

Register this agent with a ShutterSense server. Requires a one-time registration token generated by a server administrator.

```bash
shuttersense-agent register --server <URL> --token <TOKEN> [--name <NAME>] [--force]
```

| Option | Short | Description |
| -------- | ------- | ------------- |
| `--server` | `-s` | ShutterSense server URL (required) |
| `--token` | `-t` | One-time registration token (required) |
| `--name` | `-n` | Agent display name (defaults to hostname) |
| `--force` | `-f` | Force re-registration if already registered |

The command detects system capabilities, hostname, and OS information automatically and sends them to the server during registration. After successful registration, the agent GUID and API key are saved to the local configuration file.

### start

Start the agent polling loop. The agent must be registered first.

```bash
shuttersense-agent start
```

The agent continuously polls the server for jobs, executes them locally, and reports results. It sends periodic heartbeats to maintain its online status. Stop with Ctrl+C or SIGTERM.

### config

Manage agent configuration, particularly authorized local filesystem roots.

#### config set-roots

Replace all authorized roots with the specified paths:

```bash
shuttersense-agent config set-roots /Users/photographer/Photos /Volumes/External
```

#### config get-roots

Display current authorized roots with accessibility status:

```bash
shuttersense-agent config get-roots
```

#### config add-root

Add a single path to authorized roots:

```bash
shuttersense-agent config add-root /Volumes/NewDrive
```

#### config remove-root

Remove a path from authorized roots:

```bash
shuttersense-agent config remove-root /Volumes/OldDrive
```

Changes to authorized roots require an agent restart to take effect.

### connectors

Manage connector credentials for cloud and network storage. Credentials are encrypted and stored locally on the agent machine using the `CredentialStore`.

#### connectors list

List connectors available for credential configuration:

```bash
shuttersense-agent connectors list [--pending] [--json]
```

| Option | Description |
| -------- | ------------- |
| `--pending` | Only show connectors pending credential configuration |
| `--json` | Output as JSON |

#### connectors configure

Interactively configure credentials for a connector. Prompts for connector-specific fields, optionally tests them, then stores encrypted locally:

```bash
shuttersense-agent connectors configure <GUID> [--test/--no-test] [--force]
```

| Option | Description |
| -------- | ------------- |
| `--test/--no-test` | Test credentials before storing (default: test) |
| `--force` | Overwrite existing credentials without prompting |

Supported connector types: **S3**, **GCS**, **SMB**.

#### connectors show

Display stored credentials for a connector (sensitive values are masked):

```bash
shuttersense-agent connectors show <GUID>
```

#### connectors test

Test existing credentials without modifying them and optionally report capability to the server:

```bash
shuttersense-agent connectors test <GUID> [--report/--no-report]
```

#### connectors remove

Remove stored credentials for a connector:

```bash
shuttersense-agent connectors remove <GUID> [--force]
```

### capabilities

Display all capabilities this agent can report to the server:

```bash
shuttersense-agent capabilities [--json]
```

Shows:
- Built-in capabilities (local filesystem access)
- Tool capabilities (photostats, photo_pairing, pipeline_validation)
- Connector credentials stored locally
- Authorized local roots

### test

Test a local directory for accessibility and optionally run analysis tools. Results are cached locally for 24 hours.

```bash
shuttersense-agent test <PATH> [--tool <TOOL>] [--check-only] [--output <PATH>]
```

| Option | Short | Description |
| -------- | ------- | ------------- |
| `--tool` | | Run only this analysis tool (default: all) |
| `--check-only` | | Only check accessibility, skip analysis |
| `--output` | `-o` | Save HTML report (file path with `--tool`, directory path without) |

Examples:

```bash
# Basic accessibility check
shuttersense-agent test /photos/2024 --check-only

# Run all analysis tools
shuttersense-agent test /photos/2024

# Run a single tool and save the HTML report
shuttersense-agent test /photos/2024 --tool photostats -o report.html

# Run all tools and save reports to a directory
shuttersense-agent test /photos/2024 -o ./reports/
```

Analysis tools require team configuration from the server (extensions, camera mappings, processing methods, pipeline definition). Use `--check-only` when the server is unavailable and no cached config exists.

### collection

Manage Collections bound to this agent.

#### collection create

Create a Collection on the server from a local path:

```bash
shuttersense-agent collection create <PATH> [--name <NAME>] [--skip-test] [--analyze]
```

| Option | Short | Description |
| -------- | ------- | ------------- |
| `--name` | `-n` | Collection display name (defaults to folder name) |
| `--skip-test` | | Skip test validation (use with caution) |
| `--analyze` | | Queue initial analysis after creation (not yet implemented) |

The command checks the local test cache for a valid entry (within 24 hours). If no valid cache exists and `--skip-test` is not set, the test command runs automatically before creating the collection.

#### collection list

List Collections bound to this agent:

```bash
shuttersense-agent collection list [--type <TYPE>] [--status <STATUS>] [--offline]
```

| Option | Short | Description |
| -------- | ------- | ------------- |
| `--type` | `-t` | Filter by type: LOCAL, S3, GCS, SMB |
| `--status` | `-s` | Filter by status: accessible, inaccessible, pending |
| `--offline` | | Use locally cached data instead of fetching from server |

#### collection sync

Refresh local collection cache from the server:

```bash
shuttersense-agent collection sync
```

#### collection test

Re-test a Collection's local path accessibility and report to the server:

```bash
shuttersense-agent collection test <GUID>
```

Only works for LOCAL collections. Requires the collection to be in the local cache (run `collection sync` first).

### run

Execute an analysis tool against a Collection:

```bash
shuttersense-agent run <COLLECTION_GUID> --tool <TOOL> [--offline] [--output <PATH>]
```

| Option | Short | Description |
| -------- | ------- | ------------- |
| `--tool` | `-t` | Analysis tool to run (required): photostats, photo_pairing, pipeline_validation |
| `--offline` | | Store result locally for later sync (LOCAL collections only) |
| `--output` | `-o` | Save HTML report to this path |

**Online mode** (default): Executes the tool locally, computes the Input State hash, checks for no-change against the previous result, and uploads results to the server.

**Offline mode**: Executes locally and stores results in the local result store. Use `shuttersense-agent sync` to upload later.

Examples:

```bash
# Online execution (uploads results to server)
shuttersense-agent run col_01hgw... --tool photostats

# Offline execution (saves locally)
shuttersense-agent run col_01hgw... --tool photo_pairing --offline

# Save HTML report alongside upload
shuttersense-agent run col_01hgw... --tool photostats --output report.html
```

### sync

Upload offline analysis results to the server:

```bash
shuttersense-agent sync [--dry-run]
```

| Option | Description |
| -------- | ------------- |
| `--dry-run` | List pending results without uploading |

Scans the local result store for pending results, uploads each one, and cleans up successfully uploaded result files from disk. Results that already exist on the server (HTTP 409) are automatically cleaned up.

### self-test

Verify agent configuration and server connectivity:

```bash
shuttersense-agent self-test
```

Performs diagnostic checks:
- **Server connectivity**: URL reachable, latency measurement
- **Agent registration**: API key valid, not revoked
- **Tool availability**: Analysis tools importable
- **Authorized roots**: Configured paths accessible

Exit codes: `0` = all pass, `1` = warnings only, `2` = failures. Provides actionable remediation suggestions for any failures.

### debug (dev-only)

Development-only diagnostic commands. Not included in production builds.

**Requires**: `SHUTTERSENSE_DEBUG_COMMANDS=1` environment variable.

#### debug compare-inventory

Compare FileInfo from the two most recent inventory manifests for a connector:

```bash
SHUTTERSENSE_DEBUG_COMMANDS=1 shuttersense-agent debug compare-inventory <CONNECTOR_GUID> \
  [--collection <COL_GUID>] [--tool <TOOL>] [--list-folders] [--dump] \
  [--limit N] [--show-all] [--verbose]
```

Useful for diagnosing Input State hash mismatches between inventory import runs. Shows diff of added, removed, and changed entries between manifests. With `--dump`, writes a detailed Markdown file with all intermediate hash computation data.

## Source Structure

```
agent/
├── cli/                              # CLI commands (Click)
│   ├── main.py                       # Entry point, registers all subcommands
│   ├── register.py                   # Agent registration with server
│   ├── start.py                      # Start agent polling loop
│   ├── config.py                     # Manage authorized roots (set/get/add/remove)
│   ├── connectors.py                 # Manage connector credentials (S3, GCS, SMB)
│   ├── capabilities.py               # Show agent capabilities
│   ├── test.py                       # Validate local path, run analysis tools
│   ├── collection.py                 # Manage Collections (create, list, sync, test)
│   ├── run.py                        # Execute analysis tool against Collection
│   ├── sync_results.py               # Upload offline results to server
│   ├── self_test.py                  # Verify configuration and connectivity
│   └── debug.py                      # Dev-only diagnostic commands
│
├── src/                              # Core source code
│   ├── __init__.py                   # Package init, exposes __version__
│   ├── _version.py                   # Auto-generated version (hatch-vcs)
│   ├── main.py                       # Agent runtime entry point (run_agent)
│   │
│   ├── analysis/                     # Shared analysis modules
│   │   ├── photostats_analyzer.py    # File statistics and pairing analysis
│   │   ├── photo_pairing_analyzer.py # Image grouping and naming validation
│   │   ├── pipeline_analyzer.py      # Pipeline validation against definitions
│   │   ├── pipeline_config_builder.py# Build pipeline config from node/edge JSON
│   │   ├── inventory_parser.py       # S3/GCS inventory manifest and data parsing
│   │   └── report_generators.py      # HTML report generation (Jinja2 templates)
│   │
│   ├── remote/                       # Storage adapters
│   │   ├── base.py                   # Abstract base (StorageAdapter, FileInfo)
│   │   ├── local_adapter.py          # Local filesystem adapter
│   │   ├── s3_adapter.py             # AWS S3 adapter (boto3)
│   │   ├── gcs_adapter.py            # Google Cloud Storage adapter
│   │   └── smb_adapter.py            # SMB/CIFS network share adapter
│   │
│   ├── cache/                        # Local caching subsystem
│   │   ├── collection_cache.py       # Collection metadata cache (JSON)
│   │   ├── result_store.py           # Offline analysis result storage
│   │   ├── team_config_cache.py      # Team configuration cache (extensions, cameras)
│   │   └── test_cache.py             # Test result cache (24-hour TTL)
│   │
│   ├── tools/                        # Specialized tool implementations
│   │   └── inventory_import_tool.py  # S3/GCS bucket inventory import
│   │
│   ├── api_client.py                 # Server HTTP client (httpx-based)
│   ├── config.py                     # AgentConfig class (YAML-based)
│   ├── config_loader.py              # Configuration loading utilities
│   ├── config_resolver.py            # Team config resolution (server + cache)
│   ├── job_executor.py               # Job execution engine
│   ├── polling_loop.py               # Server polling loop
│   ├── progress_reporter.py          # Real-time progress streaming (WebSocket)
│   ├── metrics.py                    # Agent metrics collection
│   ├── credential_store.py           # Encrypted local credential storage (Fernet)
│   ├── chunked_upload.py             # Large payload chunked upload
│   ├── attestation.py                # Result attestation
│   ├── result_signer.py              # Result signing for integrity
│   ├── capabilities.py               # Capability detection (tools, filesystem)
│   └── input_state.py                # Input State hash computation
│
├── tests/                            # Test suites (39 files, 678 functions)
├── packaging/                        # Build scripts (PyInstaller)
│   ├── build_macos.sh
│   ├── build_linux.sh
│   ├── build_windows.sh
│   ├── build_all.sh
│   └── create_release.sh
├── pyproject.toml                    # Project metadata and dependencies
└── README.md                         # This file
```

## Configuration

### Config File

Agent configuration is stored as a YAML file named `agent-config.yaml` in a platform-specific directory:

| Platform | Path |
| ---------- | ------ |
| **macOS** | `~/Library/Application Support/shuttersense/agent-config.yaml` |
| **Linux** | `~/.config/shuttersense/agent-config.yaml` |
| **Windows** | `%APPDATA%\shuttersense\agent-config.yaml` |

The configuration file is created automatically during registration. Example contents:

```yaml
server_url: https://your-server.example.com
api_key: <auto-generated during registration>
agent_guid: agt_01hgw2bbg0000000000000001
agent_name: My Workstation
authorized_roots:
  - /Users/photographer/Photos
  - /Volumes/External
heartbeat_interval_seconds: 30
poll_interval_seconds: 5
log_level: INFO
```

### Data Directory

Cached data (collections, test results, offline results) is stored in the platform data directory:

| Platform | Path |
| ---------- | ------ |
| **macOS** | `~/Library/Application Support/shuttersense/` |
| **Linux** | `~/.local/share/shuttersense/` |
| **Windows** | `%APPDATA%\shuttersense\` |

Contents:
- `collection-cache.json` -- Cached collection metadata from server
- `team-config-cache.json` -- Cached team configuration (extensions, cameras, pipeline)
- `test-cache/` -- Test result cache files (24-hour TTL)
- `results/` -- Offline analysis results pending sync

### Configuration Priority

Configuration values are resolved in this order (highest priority first):

1. **Environment variables** (`SHUTTERSENSE_SERVER_URL`, `SHUTTERSENSE_API_KEY`, `SHUTTERSENSE_LOG_LEVEL`)
2. **Configuration file** (`agent-config.yaml`)
3. **Default values**

## Environment Variables

| Variable | Description |
| ---------- | ------------- |
| `SHUTTERSENSE_SERVER_URL` | Override server URL from config file |
| `SHUTTERSENSE_API_KEY` | Override API key from config file |
| `SHUTTERSENSE_LOG_LEVEL` | Override log level (DEBUG, INFO, WARNING, ERROR) |
| `SHUTTERSENSE_CONFIG_PATH` | Override config file path |
| `SHUTTERSENSE_DEBUG_COMMANDS` | Set to `1` to enable debug CLI commands |
| `SHUTTERSENSE_AGENT_DEV_MODE` | Set to `1` to enable development mode |
| `SHUSAI_VERSION` | Override version string (for CI/CD without Git) |

## Storage Adapters

The agent supports multiple storage backends through a unified adapter interface:

| Adapter | Module | Description |
| --------- | -------- | ------------- |
| **Local** | `src/remote/local_adapter.py` | Local filesystem access |
| **S3** | `src/remote/s3_adapter.py` | AWS S3 buckets (via boto3) |
| **GCS** | `src/remote/gcs_adapter.py` | Google Cloud Storage buckets |
| **SMB** | `src/remote/smb_adapter.py` | SMB/CIFS network shares |

All adapters implement the `StorageAdapter` base class from `src/remote/base.py`, providing a common `FileInfo` data class and `list_files_with_metadata()` interface.

For cloud connectors (S3, GCS, SMB), credentials are configured via `shuttersense-agent connectors configure` and stored encrypted locally using Fernet encryption in the `CredentialStore`.

## Analysis Tools

The agent includes three analysis tools, each producing structured JSON data and optional HTML reports:

### photostats

File statistics and pairing analysis. Counts files by type, calculates storage usage, and identifies orphaned images (photos without sidecars) and orphaned XMP files (sidecars without matching photos).

### photo_pairing

Image grouping and naming validation. Groups photos by camera ID and counter, identifies processing methods (HDR, BW, etc.), and reports files with invalid naming conventions.

### pipeline_validation

Validates photo collections against pipeline definitions. Checks that each image group has traversed the expected pipeline nodes and reports consistency status (CONSISTENT, PARTIAL, INCONSISTENT).

All tools use the team configuration from the server (or local cache) for file extension definitions, camera mappings, and processing method labels.

## Caching

The agent maintains several local caches for offline operation and performance:

| Cache | File | TTL | Purpose |
| ------- | ------ | ----- | --------- |
| **Collection cache** | `collection-cache.json` | Configurable | Collection metadata for offline listing and `run` |
| **Team config cache** | `team-config-cache.json` | Configurable | Extensions, cameras, processing methods, pipeline |
| **Test cache** | `test-cache/<hash>.json` | 24 hours | Test results to avoid redundant path checks |
| **Result store** | `results/<id>.json` | Until synced | Offline analysis results pending upload |

## Testing

### Running Tests

```bash
# Run all agent tests
python3 -m pytest agent/tests/ -v

# Run with coverage
python3 -m pytest agent/tests/ --cov=src --cov=cli --cov-report=term-missing

# Run a specific test file
python3 -m pytest agent/tests/test_config.py -v

# Run tests matching a pattern
python3 -m pytest agent/tests/ -k "test_register" -v
```

### Test Stack

- **pytest** -- Test framework
- **pytest-asyncio** -- Async test support (mode: auto)
- **pytest-cov** -- Coverage reporting
- **pytest-mock** -- Mocking utilities
- **respx** -- Mock httpx requests

### Test Scope

The agent test suite contains 39 test files with 678 test functions covering:

- CLI commands (register, start, config, connectors, collection, run, sync, self-test)
- API client communication
- Configuration loading and validation
- Cache operations (collection, team config, test, result store)
- Analysis tools (photostats, photo pairing, pipeline validation)
- Storage adapters
- Credential storage encryption
- Input State hash computation
- Job execution engine

### Code Quality

```bash
# Lint with ruff
ruff check agent/

# Format check
ruff format --check agent/
```

Ruff is configured with line length 120, targeting Python 3.10, with pycodestyle, Pyflakes, isort, flake8-bugbear, flake8-comprehensions, and pyupgrade rules.

## Building

### PyInstaller Binary

The packaging scripts produce a single-file executable:

```bash
cd agent
pip install -e ".[build]"
./packaging/build_macos.sh  # or build_linux.sh / build_windows.sh
```

### Python Package

The agent uses `hatchling` as the build backend with `hatch-vcs` for automatic version detection from Git tags:

```bash
cd agent
pip install build
python -m build
```

## Dependencies

### Runtime

| Package | Version | Purpose |
| --------- | --------- | --------- |
| httpx | >= 0.24.0 | HTTP client for REST API communication |
| websockets | >= 11.0 | Real-time progress streaming |
| pydantic | >= 2.0 | Data validation and serialization |
| pydantic-settings | >= 2.0 | Settings management |
| cryptography | >= 41.0 | Encrypted local credential storage (Fernet) |
| click | >= 8.1 | CLI framework |
| PyYAML | >= 6.0 | Configuration file parsing |
| platformdirs | >= 3.0 | Platform-specific directory detection |
| pyarrow | >= 14.0.0 | Parquet format support for inventory import |

### Development

| Package | Version | Purpose |
| --------- | --------- | --------- |
| pytest | >= 7.0 | Test framework |
| pytest-asyncio | >= 0.21 | Async test support |
| pytest-cov | >= 4.0 | Coverage reporting |
| pytest-mock | >= 3.10 | Mocking utilities |
| respx | >= 0.20 | Mock httpx requests |
| ruff | >= 0.1 | Linting and formatting |
| Jinja2 | >= 3.1.0 | HTML report template rendering (tests) |

### Build

| Package | Version | Purpose |
| --------- | --------- | --------- |
| pyinstaller | >= 5.0 | Standalone binary packaging |
| hatchling | -- | Build backend |
| hatch-vcs | -- | Git-based version detection |

## Requirements

- Python 3.10+ (required for `match`/`case` syntax and modern type hints)
- Network access to a ShutterSense server (for online operations)
- Optional: boto3 (for S3 connector testing), google-cloud-storage (for GCS), smbprotocol (for SMB)

## License

GNU Affero General Public License v3.0 (AGPL-3.0)
