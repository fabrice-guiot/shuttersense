# photo-admin Development Guidelines

Auto-generated from all feature plans. Last updated: 2026-01-09

## Project Overview

Photo Administration toolbox - A comprehensive solution for analyzing, managing, and validating photo collections across local and remote storage.

### CLI Tools

1. **PhotoStats** - Analyze photo collections for orphaned files and sidecar issues
2. **Photo Pairing Tool** - Analyze filename patterns, group files, track camera usage
3. **Pipeline Validation** - Validate collections against user-defined processing workflows

### Web Application

- **Backend** (FastAPI) - RESTful API with PostgreSQL storage, encrypted credentials, job queuing
- **Frontend** (React/TypeScript) - Modern, accessible UI with real-time progress updates

## Active Technologies
- Python 3.10+ (Backend), TypeScript 5.x (Frontend) + FastAPI, SQLAlchemy 2.0, Pydantic v2, React 18.3.1, Axios (008-entity-uuid-implementation)
- PostgreSQL 12+ with JSONB columns (SQLite for tests) (008-entity-uuid-implementation)
- TypeScript 5.x (Frontend), React 18.3.1 + Tailwind CSS 4.x, shadcn/ui components, Radix UI primitives, class-variance-authority (cva) (009-dark-theme-compliance)
- N/A (styling-only feature, no data persistence changes) (009-dark-theme-compliance)
- TypeScript 5.9.3 + React 18.3.1, Vite 6.0.5, native browser Intl APIs (no external date libraries) (010-user-timezone-display)
- N/A (frontend-only feature, backend continues storing UTC timestamps) (010-user-timezone-display)

### Core Stack
- **Python 3.10+** - Backend and CLI tools (required for match/case syntax)
- **TypeScript 5.x** - Frontend type safety
- **React 18.3.1** - Frontend UI framework
- **FastAPI** - Backend web framework with OpenAPI docs
- **PostgreSQL 12+** - Primary database with JSONB columns

### CLI Dependencies
- **PyYAML** (>=6.0) - Configuration file handling
- **Jinja2** (>=3.1.0) - HTML template rendering
- **pytest** - Testing framework
- **Chart.js** - HTML report visualizations (via CDN)

### Security Features (Phase 7)
- **slowapi** - Rate limiting middleware
- **Fernet encryption** - Encrypted credential storage
- Security headers (CSP, X-Frame-Options, etc.)
- SQL injection prevention via SQLAlchemy ORM
- Credential access audit logging

## Project Structure

```text
photo-admin/
├── photo_stats.py              # PhotoStats tool
├── photo_pairing.py            # Photo Pairing tool
├── utils/                      # Shared utilities
│   ├── config_manager.py      # PhotoAdminConfig class
│   └── filename_parser.py     # FilenameParser class
├── config/
│   ├── template-config.yaml   # Configuration template
│   └── config.yaml            # User configuration (gitignored)
├── docs/                      # Documentation
│   ├── installation.md
│   ├── configuration.md
│   ├── photostats.md
│   └── photo-pairing.md
├── specs/                     # Design specifications
│   └── 001-photo-pairing-tool/
├── tests/                     # Test suites
│   ├── test_photo_stats.py    # 47 tests
│   └── test_photo_pairing.py  # 40 tests
└── requirements.txt           # Python dependencies
```

## Version Management

Photo-admin uses a centralized version management system that automatically synchronizes version numbers across all components with GitHub release tags.

### Version Module (`version.py`)

The `version.py` module provides a single source of truth for version information:

- **Tagged releases**: Returns clean tag (e.g., `v1.2.3`)
- **Development builds**: Returns tag with suffix (e.g., `v1.2.3-dev.5+a1b2c3d`)
- **No tags**: Returns development version (e.g., `v0.0.0-dev+a1b2c3d`)
- **No Git**: Falls back to `PHOTO_ADMIN_VERSION` environment variable or `v0.0.0-dev+unknown`

### Version Display Locations

All components use the same version from `version.py`:

1. **CLI Tools** (`--version` flag):
   - `python3 photo_stats.py --version`
   - `python3 photo_pairing.py --version`
   - `python3 pipeline_validation.py --version`

2. **Backend API**:
   - FastAPI app version (shown in `/docs`)
   - `/api/version` endpoint
   - `/health` endpoint

3. **Frontend**:
   - Sidebar footer (fetched from `/api/version`)
   - Displayed dynamically via `useVersion()` hook

4. **HTML Reports**:
   - Report footer (e.g., "Generated by PhotoStats v1.2.3")

### Usage in Code

```python
# Python CLI tools and backend
from version import __version__

print(f"Tool version: {__version__}")
```

```typescript
// TypeScript frontend
import { useVersion } from '@/hooks/useVersion'

const { version, loading, error } = useVersion()
```

### Development Version Format

During development (commits after a tag), the version includes:
- **Base version**: Latest Git tag
- **Commits since**: Number of commits since tag
- **Commit hash**: Short hash for traceability

Example: `v1.2.3-dev.5+a1b2c3d` means:
- Latest tag: `v1.2.3`
- 5 commits ahead of tag
- Current commit: `a1b2c3d`

### CI/CD Integration

For CI/CD environments without Git:
- Set `PHOTO_ADMIN_VERSION` environment variable
- Example: `export PHOTO_ADMIN_VERSION=v1.5.0-build.42`

### Creating Releases

To create a new release:
1. Tag the commit: `git tag v1.3.0`
2. Push tag: `git push origin v1.3.0`
3. All components automatically use `v1.3.0`

## Commands

### Running Tools

```bash
# PhotoStats - analyze photo collections
python3 photo_stats.py /path/to/photos

# Photo Pairing - analyze filename patterns
python3 photo_pairing.py /path/to/photos
```

### Testing

```bash
# Run all tests
python3 -m pytest tests/

# Run specific tool tests
python3 -m pytest tests/test_photo_stats.py -v
python3 -m pytest tests/test_photo_pairing.py -v

# Run with coverage
python3 -m pytest tests/ --cov=photo_pairing --cov=utils --cov-report=term-missing
```

### Code Quality

```bash
# Run linter (if ruff is installed)
ruff check .

# Format code (if black is installed)
black .
```

## Code Style

- **Python 3.10+**: Follow PEP 8 conventions
- **Docstrings**: All functions should have clear docstrings with Args/Returns
- **Type hints**: Use where beneficial for clarity
- **Testing**: Write tests alongside implementation (flexible TDD)

## Frontend Architecture

### Design System (Required Reading)

All frontend development MUST follow the Design System documentation at `frontend/docs/design-system.md`. Key requirements:

- **Colors**: Use design tokens, never hardcoded colors
- **Buttons**: Primary=default, Cancel=outline, Delete=destructive, Icons=ghost
- **Status Colors**: success=positive, destructive=negative, muted=inactive, info=archived
- **Domain Labels**: Import from centralized `@/contracts/domain-labels.ts`
- **Error Handling**: Page errors at top, form errors above buttons, field errors via FormMessage
- **Icons**: Use consistent domain icons (Collection=FolderOpen, Connector=Plug, etc.)

See [Design System](frontend/docs/design-system.md) for complete guidelines.

### TopHeader KPI Pattern (Required for all pages)

All frontend pages MUST display relevant KPIs in the TopHeader stats area (next to the bell icon). This is a mandatory UX pattern established in Issue #37.

**Key Files**:
- `frontend/src/contexts/HeaderStatsContext.tsx` - Context for dynamic stats
- `frontend/src/components/layout/TopHeader.tsx` - Displays stats in header
- `frontend/src/components/layout/MainLayout.tsx` - Wraps pages in HeaderStatsProvider

**Implementation Pattern**:
```typescript
// 1. Create a stats hook in hooks/use<Domain>.ts
export const use<Domain>Stats = () => {
  const [stats, setStats] = useState<StatsResponse | null>(null)
  // Fetch from /api/<domain>/stats endpoint
  return { stats, loading, error, refetch }
}

// 2. In page component, set header stats
import { useHeaderStats } from '@/contexts/HeaderStatsContext'

const { stats } = use<Domain>Stats()
const { setStats } = useHeaderStats()

useEffect(() => {
  if (stats) {
    setStats([
      { label: 'Total Items', value: stats.total_count },
      { label: 'Active Items', value: stats.active_count },
    ])
  }
  return () => setStats([])  // Clear on unmount
}, [stats, setStats])
```

**Backend Requirements**:
- Each domain SHOULD have a `GET /api/<domain>/stats` endpoint
- Stats endpoints return aggregated KPIs independent of any filters
- Response schema: `<Domain>StatsResponse` in `backend/src/schemas/`

**Examples**:
- Collections: Total Collections, Storage Used, Total Files, Total Images
- Connectors: Active Connectors, Total Connectors

## Architecture Principles (Constitution)

### 0. Global Unique Identifiers (GUIDs) - Issue #42

All entities in the presentation layer (APIs, URLs, UI) are identified exclusively by GUIDs. Numeric IDs are internal-only.

**GUID Format:** `{prefix}_{26-char Crockford Base32}`

Example: `col_01hgw2bbg0000000000000001`

**Entity Prefixes (Implemented):**

| Entity | Prefix | Example |
|--------|--------|---------|
| Collection | `col_` | `col_01hgw2bbg...` |
| Connector | `con_` | `con_01hgw2bbg...` |
| Pipeline | `pip_` | `pip_01hgw2bbg...` |
| Result | `res_` | `res_01hgw2bbg...` |
| Job | `job_` | `job_01hgw2bbg...` |
| ImportSession | `imp_` | `imp_01hgw2bbg...` |

**Key Files:**
- `backend/src/services/guid.py` - GuidService for generation/validation
- `backend/src/models/mixins/external_id.py` - ExternalIdMixin for DB entities
- `frontend/src/utils/guid.ts` - Frontend utilities

**Rules:**
- API responses use `.guid` property (never expose internal `.id`)
- Path parameters use `{guid}` for entity endpoints
- Foreign key references in responses use `_guid` suffix (e.g., `collection_guid`)
- All new entities MUST implement this pattern

See `docs/domain-model.md` for the complete prefix table including planned entities.

### 1. Independent CLI Tools
- Each tool is a standalone Python script at repository root
- Tools can run independently without requiring other tools
- Use shared infrastructure (PhotoAdminConfig, utils/) but remain decoupled

### 2. Testing & Quality
- Comprehensive test coverage (target >80% for core logic)
- pytest framework with fixtures in conftest.py
- Both unit tests and integration tests
- Tests can be written alongside implementation (flexible approach)

### 3. User-Centric Design
- Interactive HTML reports with visualizations
- Clear, actionable error messages
- Progress indicators for long operations
- Simple, focused implementations (YAGNI principle)

### 4. Shared Infrastructure
- **PhotoAdminConfig**: Shared configuration management
- **Utils**: Reusable utility classes (FilenameParser, etc.)
- Standard config schema with extensible design
- Consistent file naming conventions

### 5. Simplicity
- Direct implementations without over-engineering
- No premature abstractions
- Minimal dependencies (PyYAML, Jinja2 for templates)
- Straightforward data structures
- Industry-standard tools (Jinja2 for templating)

## Configuration

### Config File Locations (Priority Order)

1. `./config/config.yaml` (current directory)
2. `./config.yaml` (current directory)
3. `~/.photo_stats_config.yaml` (home directory)
4. `<script-dir>/config/config.yaml` (installation directory)

### Config Schema

```yaml
photo_extensions:
  - .dng
  - .cr3
  - .tiff

metadata_extensions:
  - .xmp

require_sidecar:
  - .cr3

camera_mappings:
  AB3D:
    - name: Canon EOS R5
      serial_number: "12345"

processing_methods:
  HDR: High Dynamic Range
  BW: Black and White
```

## Shared Utilities

### PhotoAdminConfig (utils/config_manager.py)

Manages configuration loading and interactive prompts:

```python
from utils.config_manager import PhotoAdminConfig

config = PhotoAdminConfig()
# Or with explicit path:
config = PhotoAdminConfig(config_path='/path/to/config.yaml')

# Access configuration
photo_exts = config.photo_extensions
camera_map = config.camera_mappings

# Interactive prompts (auto-saves to config)
camera_info = config.ensure_camera_mapping('AB3D')
method_desc = config.ensure_processing_method('HDR')
```

### FilenameParser (utils/filename_parser.py)

Validates and parses photo filenames:

```python
from utils.filename_parser import FilenameParser

# Validate filename
is_valid, error = FilenameParser.validate_filename('AB3D0001-HDR.dng')

# Parse filename
parsed = FilenameParser.parse_filename('AB3D0001-HDR.dng')
# Returns: {'camera_id': 'AB3D', 'counter': '0001',
#           'properties': ['HDR'], 'extension': '.dng'}

# Detect property type
prop_type = FilenameParser.detect_property_type('2')  # 'separate_image'
prop_type = FilenameParser.detect_property_type('HDR')  # 'processing_method'
```

## Recent Changes
- 010-user-timezone-display: Added TypeScript 5.9.3 + React 18.3.1, Vite 6.0.5, native browser Intl APIs (no external date libraries)
- 009-dark-theme-compliance: Added TypeScript 5.x (Frontend), React 18.3.1 + Tailwind CSS 4.x, shadcn/ui components, Radix UI primitives, class-variance-authority (cva)
- 008-entity-uuid-implementation: Added Python 3.10+ (Backend), TypeScript 5.x (Frontend) + FastAPI, SQLAlchemy 2.0, Pydantic v2, React 18.3.1, Axios

### Phase 7 Production-Ready Application (2026-01-09)

### HTML Report Consistency & Tool Improvements (2025-12-25)
  - Created templates/base.html.j2 with shared styling and Chart.js theme
  - Tool-specific templates extend base for PhotoStats and Photo Pairing
  - Removed 640+ lines of duplicate HTML generation code
  - Migrated PhotoStats from manual argv parsing to argparse
  - Enhanced Photo Pairing help with examples and workflow
  - Both tools support --help and -h flags
  - User-friendly "Operation interrupted by user" message
  - Exit code 130 (standard for SIGINT)
  - Atomic file writes prevent partial reports
  - Shutdown checks in scan loops and before report generation
  - PhotoStats: photo_stats_report_YYYY-MM-DD_HH-MM-SS.html
  - Photo Pairing: photo_pairing_report_YYYY-MM-DD_HH-MM-SS.html
  - Report renderer tests (12): template rendering, visual consistency
  - Help text tests (6): --help/-h flag validation
  - Signal handling tests (7): CTRL+C graceful interruption

### Photo Pairing Tool (2025-12-25)

### Code Refactoring (2025-12-24)

## Testing Guidelines

### Test Organization

- **Fixtures**: Define reusable test data in fixtures
- **Test Classes**: Group related tests by functionality
- **Integration Tests**: Test complete workflows end-to-end
- **Mocking**: Use monkeypatch for user input, file I/O, etc.

### Coverage Targets

- Core business logic: >80%
- Utility functions: >85%
- Overall: >65% (accounts for CLI code)

### Example Test Structure

```python
import pytest
from utils.filename_parser import FilenameParser

class TestFilenameValidation:
    """Tests for filename validation"""

    def test_valid_filename(self):
        is_valid, error = FilenameParser.validate_filename('AB3D0001.dng')
        assert is_valid
        assert error is None

    def test_invalid_counter(self):
        is_valid, error = FilenameParser.validate_filename('AB3D0000.dng')
        assert not is_valid
        assert 'Counter cannot be 0000' in error
```

## Documentation Standards

### Code Documentation

- Module-level docstrings explaining purpose
- Function docstrings with Args, Returns, and Raises
- Inline comments for complex logic only

### User Documentation

- Installation guide (docs/installation.md)
- Configuration guide (docs/configuration.md)
- Tool-specific guides (docs/photostats.md, docs/photo-pairing.md)
- README.md with quick start and overview

### Tool Help Output

- Include usage examples in `--help`
- Show expected workflow
- Provide sample commands

## License

GNU Affero General Public License v3.0 (AGPL-3.0)

<!-- MANUAL ADDITIONS START -->
<!-- MANUAL ADDITIONS END -->
